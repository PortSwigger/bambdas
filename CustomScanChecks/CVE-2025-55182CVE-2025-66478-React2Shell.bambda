id: 7536c98a-0329-4e0f-901a-fb316748b322
name: CVE-2025-55182,CVE-2025-66478 - React2Shell
function: SCAN_CHECK_ACTIVE_PER_HOST
location: SCANNER
source: |-
  /**
   * Active scan check for CVE-2025-55182 (React) and CVE-2025-66478 (Next.js/Vite).
   *
   * The vulnerability exploits insecure deserialization in the RSC Flight protocol
   * where unvalidated colon-delimited property references cause server crashes
   * that can lead to RCE (CVSS 10.0).
   *
   * Supports detection for:
   * - Next.js (via Next-Action header)
   * - Vite RSC (via x-rsc-action header)
   *
   * @author Dave Paterson, PortSwigger (Next.js detection)
   * @author acheong08 (Vite RSC detection)
   */
  
  String boundary = "----WebKitFormBoundary" + UUID.randomUUID().toString().replace("-", "").substring(0, 16);
  String host = requestResponse.request().httpService().host();
  
  // === NEXT.JS CHECK ===
  String nextPayload = "--" + boundary + "\r\n" +
                   "Content-Disposition: form-data; name=\"1\"\r\n\r\n" +
                   "{}\r\n" +
                   "--" + boundary + "\r\n" +
                   "Content-Disposition: form-data; name=\"0\"\r\n\r\n" +
                   "[\"$1:a:a\"]\r\n" +
                   "--" + boundary + "--\r\n";
  
  String nextRequest =
          """
          POST / HTTP/1.1\r
          Host: %s\r
          Content-Type: multipart/form-data; boundary=%s\r
          Next-Action: %s\r
          X-Nextjs-Request-Id: %s\r
          Next-Router-State-Tree: [[["",{"children":["__PAGE__",{}]},null,null,true]]\r
          \r
          """.formatted(
                  host,
                  boundary,
                  UUID.randomUUID().toString().replace("-", ""),
                  UUID.randomUUID().toString()
          );
  
  HttpRequestResponse nextResponse = http.sendRequest(HttpRequest.httpRequest(requestResponse.httpService(), nextRequest).withBody(nextPayload));
  
  if (nextResponse != null
      && nextResponse.hasResponse()
      && nextResponse.response().statusCode() == 500)
  {
      String body = nextResponse.response().bodyToString();
      if (body != null && (body.contains("E{\"digest\"") || (body.contains("digest") && body.contains("Error"))))
      {
          AuditIssue auditIssue = AuditIssue.auditIssue(
                  "CVE-2025-55182 / CVE-2025-66478 React Server Components Remote Code Execution (Next.js)",
                  """
                          <p>The application is vulnerable to <b>CVE-2025-55182</b> (React) and <b>CVE-2025-66478</b> (Next.js), \
                          critical Remote Code Execution vulnerabilities in React Server Components with CVSS score of 10.0.</p>\
                          <p><b>Vulnerability Overview:</b></p>\
                          <ul>\
                          <li>Unauthenticated Remote Code Execution via insecure deserialization</li>\
                          <li>The RSC Flight protocol fails to validate property existence in colon-delimited references</li>\
                          <li>Malformed multipart form-data triggers unhandled exceptions leading to RCE</li>\
                          <li>No prerequisites or special configuration required for exploitation</li>\
                          </ul>\
                          <p><b>Detection Evidence:</b></p>\
                          <ul>\
                          <li>Framework: Next.js</li>\
                          <li>HTTP 500 status code received</li>\
                          <li>Next.js error digest pattern detected in response</li>\
                          <li>Server failed to handle malicious property reference: <code>["$1:a:a"]</code></li>\
                          </ul>\
                          """,
                  """
                          <p><b>CRITICAL - Immediate Action Required</b></p>\
                          <p>This vulnerability allows unauthenticated attackers to execute arbitrary code on the server. \
                          Patch immediately.</p>\
                          <p><b>Upgrade to Patched Versions:</b></p>\
                          <ul>\
                          <li><b>React:</b> 19.0.1, 19.1.2, or 19.2.1</li>\
                          <li><b>Next.js:</b> 15.0.5, 15.1.9, 15.2.6, 15.3.6, 15.4.8, 15.5.7, or 16.0.7</li>\
                          </ul>\
                          <p><b>Remediation Steps:</b></p>\
                          <ol>\
                          <li>Update package.json dependencies to patched versions</li>\
                          <li>Run: <code>npm install</code> or <code>npm update</code></li>\
                          <li>Rebuild and redeploy application</li>\
                          <li>Verify fix by re-scanning</li>\
                          </ol>\
                          <p><b>References:</b></p>\
                          <ul>\
                          <li><a href="https://nextjs.org/blog/CVE-2025-66478">Next.js Security Advisory</a></li>\
                          <li><a href="https://www.wiz.io/blog/critical-vulnerability-in-react-cve-2025-55182">CVE-2025-55182 Details</a></li>\
                          <li><a href="https://slcyber.io/research-center/high-fidelity-detection-mechanism-for-rsc-next-js-rce-cve-2025-55182-cve-2025-66478/">Detection of CVE-2025-55182</a></li>\
                          </ul>""",
                  requestResponse.request().url(),
                  AuditIssueSeverity.HIGH,
                  AuditIssueConfidence.CERTAIN,
                  null,
                  null,
                  AuditIssueSeverity.HIGH,
                  nextResponse
          );
          return AuditResult.auditResult(List.of(auditIssue));
      }
  }
  
  // === VITE RSC CHECK ===
  // Vite uses x-rsc-action header instead of Next-Action
  // Detection: HTTP 500 with constructor:constructor payload indicates RSC server
  // Then timing-based check with toString payload (hangs on vulnerable servers)
  
  String viteBoundary = "----WebKitFormBoundary" + UUID.randomUUID().toString().replace("-", "").substring(0, 16);
  
  // Step 1: Check if target is a Vite RSC server
  String viteCheckPayload = "--" + viteBoundary + "\r\n" +
                       "Content-Disposition: form-data; name=\"0\"\r\n\r\n" +
                       "{\"then\":\"$1:constructor:constructor\"}\r\n" +
                       "--" + viteBoundary + "\r\n" +
                       "Content-Disposition: form-data; name=\"1\"\r\n\r\n" +
                       "{\"a\":\"b\"}\r\n" +
                       "--" + viteBoundary + "--\r\n";
  
  String viteCheckRequest =
          """
          POST / HTTP/1.1\r
          Host: %s\r
          Content-Type: multipart/form-data; boundary=%s\r
          x-rsc-action: __CVE_CHECK__#test\r
          \r
          """.formatted(host, viteBoundary);
  
  HttpRequestResponse viteCheckResponse = http.sendRequest(HttpRequest.httpRequest(requestResponse.httpService(), viteCheckRequest).withBody(viteCheckPayload));
  
  if (viteCheckResponse != null
      && viteCheckResponse.hasResponse()
      && viteCheckResponse.response().statusCode() == 500)
  {
      // Target is a Vite RSC server - now test for vulnerability using toString payload
      // On vulnerable servers, this causes an infinite hang
      // We use a short timeout to detect this behavior
      
      String viteVulnBoundary = "----WebKitFormBoundary" + UUID.randomUUID().toString().replace("-", "").substring(0, 16);
      
      String viteVulnPayload = "--" + viteVulnBoundary + "\r\n" +
                           "Content-Disposition: form-data; name=\"0\"\r\n\r\n" +
                           "{\"then\":\"$1:toString\"}\r\n" +
                           "--" + viteVulnBoundary + "\r\n" +
                           "Content-Disposition: form-data; name=\"1\"\r\n\r\n" +
                           "[\"\"]\r\n" +
                           "--" + viteVulnBoundary + "--\r\n";
  
      String viteVulnRequest =
              """
              POST / HTTP/1.1\r
              Host: %s\r
              Content-Type: multipart/form-data; boundary=%s\r
              x-rsc-action: __CVE_CHECK__#test\r
              \r
              """.formatted(host, viteVulnBoundary);
  
      // Record start time for timing-based detection
      long startTime = System.currentTimeMillis();
      
      // Send request - vulnerable servers will hang
      HttpRequestResponse viteVulnResponse = http.sendRequest(HttpRequest.httpRequest(requestResponse.httpService(), viteVulnRequest).withBody(viteVulnPayload));
      
      long elapsed = System.currentTimeMillis() - startTime;
      
      // If response took longer than 3 seconds, server likely hung (vulnerable)
      // Or if we got no response / timeout
      boolean isVulnerable = false;
      String evidenceDetail = "";
      
      if (viteVulnResponse == null || !viteVulnResponse.hasResponse())
      {
          isVulnerable = true;
          evidenceDetail = "Request timed out (server hung)";
      }
      else if (elapsed > 3000)
      {
          isVulnerable = true;
          evidenceDetail = "Request took " + elapsed + "ms (server hung)";
      }
      
      if (isVulnerable)
      {
          AuditIssue auditIssue = AuditIssue.auditIssue(
                  "CVE-2025-55182 React Server Components Remote Code Execution (Vite RSC)",
                  """
                          <p>The application is vulnerable to <b>CVE-2025-55182</b>, \
                          a critical Remote Code Execution vulnerability in React Server Components with CVSS score of 10.0.</p>\
                          <p><b>Vulnerability Overview:</b></p>\
                          <ul>\
                          <li>Unauthenticated Remote Code Execution via insecure deserialization</li>\
                          <li>The RSC Flight protocol fails to validate property existence in colon-delimited references</li>\
                          <li>Prototype chain traversal allows access to Function constructor</li>\
                          <li>No prerequisites or special configuration required for exploitation</li>\
                          </ul>\
                          <p><b>Detection Evidence:</b></p>\
                          <ul>\
                          <li>Framework: Vite RSC</li>\
                          <li>Server confirmed as Vite RSC (HTTP 500 on x-rsc-action)</li>\
                          <li>%s</li>\
                          <li>The <code>$1:toString</code> payload caused the server to hang indefinitely</li>\
                          </ul>\
                          """.formatted(evidenceDetail),
                  """
                          <p><b>CRITICAL - Immediate Action Required</b></p>\
                          <p>This vulnerability allows unauthenticated attackers to execute arbitrary code on the server. \
                          Patch immediately.</p>\
                          <p><b>Upgrade to Patched Versions:</b></p>\
                          <ul>\
                          <li><b>React:</b> 19.0.1, 19.1.2, or 19.2.1</li>\
                          </ul>\
                          <p><b>Remediation Steps:</b></p>\
                          <ol>\
                          <li>Update package.json dependencies to patched versions</li>\
                          <li>Run: <code>npm install</code> or <code>npm update</code></li>\
                          <li>Rebuild and redeploy application</li>\
                          <li>Verify fix by re-scanning</li>\
                          </ol>\
                          <p><b>References:</b></p>\
                          <ul>\
                          <li><a href="https://www.wiz.io/blog/critical-vulnerability-in-react-cve-2025-55182">CVE-2025-55182 Details</a></li>\
                          <li><a href="https://slcyber.io/research-center/high-fidelity-detection-mechanism-for-rsc-next-js-rce-cve-2025-55182-cve-2025-66478/">Detection of CVE-2025-55182</a></li>\
                          </ul>""",
                  requestResponse.request().url(),
                  AuditIssueSeverity.HIGH,
                  AuditIssueConfidence.CERTAIN,
                  null,
                  null,
                  AuditIssueSeverity.HIGH,
                  viteCheckResponse
          );
          return AuditResult.auditResult(List.of(auditIssue));
      }
  }
  
  return AuditResult.auditResult();
