<!--
*** AUTO-GENERATED FILE ***
This file is auto-generated by BambdaChecker.
Please do not manually edit this file, or include any changes to this file in pull requests.
-->
# Custom Scan Checks
Documentation: [Custom scan checks](https://portswigger.net/burp/documentation/desktop/extend-burp/custom-scan-checks)
## [CORSMisconfiguration.bambda](https://github.com/PortSwigger/bambdas/blob/main/CustomScanChecks/CORSMisconfiguration.bambda)
### Identifies CORS misconfiguration.
#### Author: PortSwigger
```java
if (!requestResponse.hasResponse())
{
    return null;
}

var evilHttps = "https://" + api().utilities().randomUtils().randomString(6) + "." + api().utilities().randomUtils().randomString(3);
var evilHttp = "http://" + api().utilities().randomUtils().randomString(6) + "." + api().utilities().randomUtils().randomString(3);

for (var origin : new String[]{evilHttps, evilHttp})
{
    var rr = http.sendRequest(requestResponse.request().withAddedHeader("Origin", origin));
    if (!rr.hasResponse())
    {
        continue;
    }

    var headers = rr.response().headers().toString().toLowerCase();
    var creds = headers.contains("access-control-allow-credentials: true");
    var reflect = headers.contains("access-control-allow-origin: " + origin.toLowerCase());
    var vary = headers.contains("vary: origin");

    if (reflect)
    {
        var severity = creds ? AuditIssueSeverity.HIGH : AuditIssueSeverity.MEDIUM;
        var note = vary ? "" : " (missing Vary: Origin)";
        return AuditResult.auditResult(
                AuditIssue.auditIssue(
                        "CORS: arbitrary origin reflection" + note,
                        "Reflected Origin: " + origin + "; credentials=" + creds,
                        "Use strict allowlist; include Vary: Origin.",
                        rr.request().url(),
                        severity,
                        AuditIssueConfidence.FIRM,
                        "",
                        "",
                        severity,
                        rr
                )
        );
    }
}

return AuditResult.auditResult();

```
## [DetectTRACEMethod.bambda](https://github.com/PortSwigger/bambdas/blob/main/CustomScanChecks/DetectTRACEMethod.bambda)
### Identifies requests with TRACE method enabled.
#### Author: PortSwigger
```java
for (var i = 0; i < 5; i++)
{
    var canary = api().utilities().randomUtils().randomString(8);
    var request = requestResponse.request().withAddedHeader("Max-Forwards", String.valueOf(i)).withHeader("Foo", canary).withMethod("TRACE");
    var response = http.sendRequest(request);

    if (response.hasResponse() && response.response().body().indexOf(canary, false) > -1)
    {
        var name = "TRACE method enabled";
        var detail =
                "<p>The server responded to a <code>TRACE</code> request and echoed back request headers, " +
                "including a unique marker header (<code>" + canary + "</code>), indicating that the TRACE method is enabled.</p>";
        var remediation =
                "<ul>" +
                "<li>Disable the TRACE method on all web servers, load balancers, and reverse proxies.</li>" +
                "<li>Block TRACE in any upstream WAF or gateway configuration.</li>" +
                "<li>Verify after changes with a TRACE request and <code>Max-Forwards</code> at each hop.</li>" +
                "</ul>";
        var background =
                "<p><code>TRACE</code> echoes the received request. If proxies or servers reflect auth headers, attackers can abuse this behavior to steal a sensitive information.</p>";
        var remediationBackground =
                "<p>Most servers allow disabling TRACE via configuration (e.g., Apache <code>TraceEnable off</code>)</p>";

        return AuditResult.auditResult(
                AuditIssue.auditIssue(
                        name,
                        detail,
                        remediation,
                        requestResponse.request().url(),
                        AuditIssueSeverity.INFORMATION,
                        AuditIssueConfidence.CERTAIN,
                        background,
                        remediationBackground,
                        AuditIssueSeverity.INFORMATION,
                        response
                )
        );
    }
}

return AuditResult.auditResult();

```
## [MissingCSPHeader.bambda](https://github.com/PortSwigger/bambdas/blob/main/CustomScanChecks/MissingCSPHeader.bambda)
### Identifies requests with missing CSP headers.
#### Author: PortSwigger
```java
if (!requestResponse.hasResponse())
{
    return AuditResult.auditResult();
}

if (!requestResponse.response().hasHeader("Content-Security-Policy"))
{
    var issueTitle = "Content Security Policy header missing";
    var issueDetail = "The response does not include a Content-Security-Policy header. Without this header the browser cannot enforce a restrictive policy for scripts, styles, images and other resources, increasing exposure to XSS, click-jacking and content-injection attacks.";
    var remediation = "Add a suitable Content-Security-Policy header, for example: Content-Security-Policy: default-src 'self'; frame-ancestors 'none'; object-src 'none'; base-uri 'none';";
    var background = "Content Security Policy (CSP) is an HTTP response header that tells the browser which sources are permitted for each resource type. A correctly configured CSP helps mitigate XSS and other code-injection flaws by limiting the origins from which content can be loaded.";
    var remediationBackground = "Create a baseline policy in report-only mode, review violation reports, then switch to enforcement. Start with default-src 'self' and add only the sources that the application legitimately requires.";

    return AuditResult.auditResult(
            AuditIssue.auditIssue(
                    issueTitle,
                    issueDetail,
                    remediation,
                    requestResponse.request().url(),
                    AuditIssueSeverity.LOW,
                    AuditIssueConfidence.FIRM,
                    background,
                    remediationBackground,
                    AuditIssueSeverity.LOW,
                    requestResponse
            )
    );
}

return AuditResult.auditResult();

```
## [SSTISampler.bambda](https://github.com/PortSwigger/bambdas/blob/main/CustomScanChecks/SSTISampler.bambda)
### Identifies server-side template injection.
#### Author: PortSwigger
```java
if (insertionPoint == null)
{
    return AuditResult.auditResult();
}

record Probe(String name, String[] payloads, String expectRegex) {}

var probes = List.of(
        new Probe("Jinja/Twig", new String[]{"{{7*7}}", "}} {{7*7}} {{", "#{7*7}#"}, "\\b49\\b"),
        new Probe("Velocity/Thymeleaf/Freemarker", new String[]{"${7*7}", "}}${7*7}{{"}, "\\b49\\b"),
        new Probe("Go template", new String[]{"{{print 7*7}}", "}} {{print 7*7}} {{"}, "\\b49\\b")
);

for (var probe : probes)
{
    for (var payload : probe.payloads())
    {
        var rr = http.sendRequest(insertionPoint.buildHttpRequestWithPayload(ByteArray.byteArray(payload)));
        if (rr.hasResponse())
        {
            var body = rr.response().body().toString();
            if (body.matches("(?s).*" + probe.expectRegex() + ".*") && !body.contains(payload))
            {
                return AuditResult.auditResult(
                        AuditIssue.auditIssue(
                                "Server-Side Template Injection (" + probe.name() + ")",
                                "Evaluated with payload: <code>" + api().utilities().htmlUtils().encode(payload) + "</code>",
                                "Avoid evaluating user input; sandbox templating.",
                                rr.request().url(),
                                AuditIssueSeverity.HIGH,
                                AuditIssueConfidence.FIRM,
                                "",
                                "",
                                AuditIssueSeverity.HIGH,
                                rr
                        )
                );
            }
        }
    }
}

return AuditResult.auditResult();

```
## [Server-sidePrototypePollution.bambda](https://github.com/PortSwigger/bambdas/blob/main/CustomScanChecks/Server-sidePrototypePollution.bambda)
### Identifies server-side prototype pollution.
#### Author: PortSwigger
```java
var statusKey = "status";
var statusVal = "555";
var request = requestResponse.request();

var basePath = request.path();
var baselineReq = http.sendRequest(request.withMethod("GET").withPath(basePath));
var baseStatus = baselineReq.hasResponse() ? baselineReq.response().statusCode() : -1;

var body = "{\"__proto__\":{\"" + statusKey + "\":" + statusVal + "}}";
var inj = http.sendRequest(request.withMethod("POST").withHeader("Content-Type", "application/json").withBody(ByteArray.byteArray(body)));

var broken = body.substring(0, body.length() - 1); // remove closing }

var errReq = http.sendRequest(
                request
                    .withMethod("POST")
                   .withHeader("Content-Type", "application/json")
                   .withBody(ByteArray.byteArray(broken))
);

if (!errReq.hasResponse())
{
    return AuditResult.auditResult();
}

var errStatus = errReq.response().statusCode();
var respBody = errReq.response().body().toString();
var statusMatch = (errStatus == Integer.parseInt(statusVal)) || respBody.contains("\"status\":" + statusVal) || respBody.contains("\"statusCode\":" + statusVal);

if (statusMatch && errStatus != baseStatus)
{
    return AuditResult.auditResult(
            AuditIssue.auditIssue(
                    "Server-side Prototype Pollution (status override)",
                    "HTTP status or JSON status/statusCode field reflects overridden value of " + statusVal + ".",
                    "Sanitize '__proto__', use null-prototype objects.",
                    requestResponse.request().url(),
                    AuditIssueSeverity.HIGH,
                    AuditIssueConfidence.FIRM,
                    "",
                    "",
                    AuditIssueSeverity.HIGH,
                    errReq
            )
    );
}

return AuditResult.auditResult();

```
